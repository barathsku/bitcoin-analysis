source:
  name: massive
  base_url: https://api.massive.com
  auth:
    type: header
    header_name: Authorization
    api_key: ouwu6g8Vu4uTkCEWINDBV985kwdlXll6
    prefix: "Bearer "
  rate_limit:
    requests_per_minute: 5

resource:
  name: forex_daily
  endpoint: /v2/aggs/ticker/{ticker}/range/{multiplier}/{timespan}/{from}/{to}
  method: GET
  path_params:
    ticker: "{ticker}"
    multiplier: "1"
    timespan: "day"
    from: "{start_date}"
    to: "{end_date}"

  # Range API returns array of bars
  extract:
    ticker:
      path: "_param.ticker"
      type: string
      partition_key: true  # Partition by ticker (forex pair) first
    data_date:
      path: "results[*].t"
      type: timestamp_ms_to_date
      partition_key: true  # Then by date
    open:
      path: "results[*].o"
    high:
      path: "results[*].h"
    low:
      path: "results[*].l"
    close:
      path: "results[*].c"
    volume:
      path: "results[*].v"

  validation:
    soda_checks:
      - row_count > 0
      - missing_count(data_date) = 0
      - missing_count(ticker) = 0
      - missing_count(close) = 0
      - open > 0
      - high > 0
      - low > 0
      - close > 0
      - high >= low
      - duplicate_count(data_date) = 0
